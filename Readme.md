# Causal Agent based on Large Language Model 

# How to run the code

This repository requires the OpenAI Python SDK v1 or newer. Install dependencies with `pip install -r requirements.txt`.

## data generation

### tabular data
use the method in Score matching enables causal discovery of nonlinear additive noise models", Rolland et al., ICML 2022.

    ./SCORE-main/demo_SCORE.py

### causal question description

generate gpt api instance

    ./DGP_description/gpt_api.py

generate causal question description by GPT-4o

    DGP_description/DGP.py

generate ground truth of causal question by classic algorithm 

    DGP_description\dataset_gt.py

tabular data is stored in [data dir](DGP_description/data)

causal graph is stored by text format in [causal_graph dir](DGP_description/causal_graph)

note that generated causal graphes doesn't reflect truth causal relationship in real world, but only reflect the causal relationship in the simulation.

### combine tabular data and description

the final data set is stored in 

    result_5_18_icl_medical.jsonl
    result_5_18_icl_market.jsonl
    result_gpt_3.5_ICL\result_ate.jsonl

file format is as follow:

    {"node num": #the number of nodes in the causal graph, 
    "question_type": #question type we care about, 
    "interest": [#variables list we will focus in the question ], 
    "variables": [#all variables in the causal graph], 
    "text": # question scenario description in natural language, 
    "file": #tabular data file we use in this question, 
    "Q": #question body in natural language, 
    "gt": #ground truth, 
    "output": #predicted answer which is generated by causal agent constructed by GPT-4o and use ICL method,
    "match"(optional): # whether generated causal graph is right in CAUSALKG and PARTIAL question }


## Causal Agent

implemented in 

    main.py

we use gpt-4o in this work. If you want to alter by other llm, you can change the code in line 323 to other model. To generate output, line 417 is the main code.

    line 417: resp = agent_executor.invoke({"input": q})

the causal question result already written in the following files:

    result_5_18_icl_medical.jsonl
    result_5_18_icl_market.jsonl
    result_gpt_3.5_ICL\result_ate.jsonl


## check the result and calculate the accuracy

the causal question result already written in the files.

you can check the result by open the jsonl file and check whether the "gt" and the "output"(json format like {'answer':'xxx'}) are matched, or output is "MATCH" directly means the generated causal graph is right in CAUSALKG and PARTIAL question.Compare the value of output and gt in ATE question.

tongji.py and jisuan.py are python code calculate the accuracy of the result swiftly. You can  change the input and run the code to satisfy your need.

## baselines

### QRdata
file folder: QRData/
ours code: main_QR.py


## resGPT

file folder: baseline-RestGPT

## Docker
To build the Docker image run:

    ./build.sh

Run the container with:

1. Copy `.env.example` to `.env` and put your OpenAI key there.
2. Execute `./run.sh` which mounts the file and runs the app.
